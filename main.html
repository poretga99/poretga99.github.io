<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pointers</title>
</head>
<body>

<table>
    <tbody>
        <tr>
            <td>
                <canvas id="canvasInput" width="512" height="512"></canvas>
            </td>
            <td>
                <canvas id="canvasOutput" width="512" height="512"></canvas>
            </td>
        </tr>
    </tbody>
</table>

<script>
    let canvasOutput = document.getElementById("canvasOutput");
    let canvasOutputCtx = canvasOutput.getContext('2d');
    let canvasInput = document.getElementById("canvasInput");
    let canvasInputCtx = canvasInput.getContext('2d');

    let width = 512;
    let height = 512;
    let numBytes = width * height * 4;

    function start() {
        console.log("Starting");

        class FrameBuffer
        {
            byteOffset = null;
            length = null;
            numBytes = null;
            dataPtr = null;
            dataOnHeap = null;
        }

        // Allocate input canvas buffer on heap
        let inputBuffer = new FrameBuffer();
        inputBuffer.dataPtr = Module._malloc(numBytes);
        inputBuffer.dataOnHeap = new Uint8Array(Module.HEAP8.buffer, inputBuffer.dataPtr, numBytes);

        // Allocate output canvas buffer on heap
        let outputBuffer = new FrameBuffer();
        outputBuffer.dataPtr = Module._malloc(numBytes);
        outputBuffer.dataOnHeap = new Uint8Array(Module.HEAP8.buffer, outputBuffer.dataPtr, numBytes);

        // Get the canvas image data and copy it to heap buffer
        inputBuffer.dataOnHeap.set(new Uint8Array(canvasInputCtx.getImageData(0, 0, width, height).data));

        // Create CavasPtrs object
        let canvasPtrs = new Module.CanvasPtrs();
        canvasPtrs.setInputCanvasPtr(inputBuffer.dataPtr, height, width);
        canvasPtrs.setOutputCanvasPtr(outputBuffer.dataPtr, height, width);
        //canvasPtrs.copyInputToOutput();
        canvasPtrs.generateGrayscale();

        // Copy image from the output buffer to the output canvas
        canvasOutputCtx.putImageData(new ImageData(new Uint8ClampedArray(outputBuffer.dataOnHeap), width, height), 0, 0);
    }

    function ready() {
        var img = new Image();
        img.onload = function() {
            canvasInputCtx.drawImage(img, 0, 0);
            start();
        };
        img.src = 'image.png';
    }
</script>

<script>
    var Module = {
        onRuntimeInitialized: function() {
            console.log("Ready");
            ready();
        }
    }
</script>
<script src="Detector.js"></script>
</body>
</html>